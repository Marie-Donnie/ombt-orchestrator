---
- name: Start the grafana container
  docker_container:
    name: "grafana"
    image: "grafana/grafana"
    detach: True
    ports:
      - "3000:3000"
    state: started

- name: Waiting for the grafana service to become available
  wait_for:
    host: "{{ grafana_vip }}"
    port: 3000
    state: started
    delay: 2
    timeout: 120

- name: Add the data sources
  uri:
    url: "http://{{ grafana_vip }}:3000/api/datasources"
    user: admin
    password: admin
    force_basic_auth: yes
    body_format: json
    method: POST
    # we workaround this issue :
    # https://github.com/ansible/ansible-modules-core/issues/265
    # by adding an empty space at the beginning of the json ...
    body: " { \"name\": \"{{ item.name }}\", \"type\": \"prometheus\", \"url\": \"http://{{ item.host }}:{{ item.port }}\", \"access\": \"proxy\", \"isDefault\": true }"
    return_content: yes
    status_code: 200,409 # already added
  with_items:
    - { name: prometheus, database: events, port: 9090, host: "{{prometheus_host }}" }
